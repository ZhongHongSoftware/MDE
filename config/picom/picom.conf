# MengXiOS Desktop Environment - Picom Configuration
# Developer: ZhongHongSoftware, Zeta
# Email: 3380089537@qq.com
# Based on: XXiaoA/dotfiles with picom-ftlabs enhancements
#
# 特性：
# - 毛玻璃效果 (Blur)
# - 圆角窗口
# - 平滑动画
# - 虚拟机优化

# ============================================================================
# 后端和性能
# ============================================================================

# 使用 GLX 后端以获得最佳性能
backend = "glx";

# 启用垂直同步以防止撕裂
vsync = true;

# GLX 后端设置
glx-no-stencil = true;
glx-no-rebind-pixmap = true;
glx-copy-from-front = false;

# 检测设置
mark-wmwin-focused = true;
mark-ovredir-focused = true;
detect-rounded-corners = true;
detect-client-opacity = true;
detect-transient = true;
detect-client-leader = true;

# 性能优化
unredir-if-possible = true;
use-damage = true;

# 日志级别
log-level = "warn";

# ============================================================================
# 圆角 (Corner Radius)
# ============================================================================

corner-radius = 12;

# 圆角排除规则
rounded-corners-exclude = [
    "window_type = 'dropdown_menu'",
    "window_type = 'popup_menu'",
    "window_type = 'popup'",
    "window_type = 'dock'",
    "window_type = 'desktop'",
    "class_g = 'Polybar'",
    "class_g = 'eww'",
    "class_g = 'Rofi'",
    "class_g = 'mpv'",
    "class_g = 'vlc'",
    # 全屏窗口不要圆角
    "fullscreen = 1",
    # 最大化窗口不要圆角
    "_NET_WM_STATE@:32a *= '_NET_WM_STATE_MAXIMIZED_VERT'",
    "_NET_WM_STATE@:32a *= '_NET_WM_STATE_MAXIMIZED_HORZ'",
];

# ============================================================================
# 阴影 (Shadows)
# ============================================================================

shadow = true;
shadow-radius = 20;
shadow-opacity = 0.75;
shadow-offset-x = -20;
shadow-offset-y = -20;
shadow-color = "#000000";

# 阴影排除规则
shadow-exclude = [
    "name = 'Notification'",
    "class_g ?= 'Notify-osd'",
    "class_g = 'slop'",
    "class_g = 'Polybar'",
    "class_g = 'eww'",
    "class_g = 'Rofi'",
    "class_g = 'Cairo-dock'",
    "class_g = 'Plank'",
    "_GTK_FRAME_EXTENTS@:c",
    "_NET_WM_STATE@:32a *= '_NET_WM_STATE_HIDDEN'",
];

# ============================================================================
# 淡入淡出 (Fading)
# ============================================================================

fading = true;
fade-delta = 3;
fade-in-step = 0.03;
fade-out-step = 0.03;

# 淡入淡出排除规则
fade-exclude = [
    "WM_CLASS@:s *= 'screenkey'",
    "class_g = 'slop'",
];

# ============================================================================
# 透明度 (Opacity)
# ============================================================================

inactive-opacity = 0.95;
inactive-opacity-override = false;
active-opacity = 1.0;

# 焦点排除
focus-exclude = [
    "class_g = 'slop'",
    "class_g = 'Cairo-dock'",
    "class_g = 'Plank'",
];

# 透明度规则
opacity-rule = [
    "100:class_g = 'Polybar'",
    "100:class_g = 'eww'",
    "100:class_g = 'TelegramDesktop'",
    "100:class_g = 'firefox'",
    "100:class_g = 'Google-chrome'",
    "100:class_g = 'Chromium'",
    "100:class_g = 'mpv'",
    "100:class_g = 'vlc'",
    "95:class_g = 'kitty' && focused",
    "90:class_g = 'kitty' && !focused",
    "95:class_g = 'wezterm' && focused",
    "90:class_g = 'wezterm' && !focused",
    "95:class_g = 'Alacritty' && focused",
    "90:class_g = 'Alacritty' && !focused",
];

# ============================================================================
# 毛玻璃效果 (Blur) - picom-ftlabs 特性
# ============================================================================

# 模糊方法：dual_kawase 提供最佳的毛玻璃效果
blur-method = "dual_kawase";

# 模糊强度 (1-20，数值越大越模糊)
blur-strength = 5;

# 模糊背景
blur-background = true;

# 模糊背景固定
blur-background-fixed = true;

# 模糊背景排除规则
blur-background-exclude = [
    "window_type = 'desktop'",
    "window_type = 'dock'",
    "_GTK_FRAME_EXTENTS@:c",
    "class_g *= 'slop'",
    "class_g *= 'Gromit-mpx'",
    "class_g *= 'wemeetapp'",
    "class_g *= 'com.github.johnfactotum.Foliate'",
    # 全屏视频不模糊
    "class_g = 'mpv' && fullscreen",
    "class_g = 'vlc' && fullscreen",
];

# ============================================================================
# 动画 (Animations) - picom-ftlabs 特性
# ============================================================================

animations = true;

# 动画刚度 (数值越大动画越快)
animation-stiffness-in-tag = 125;
animation-stiffness-tag-change = 90.0;

# 动画质量
animation-window-mass = 0.5;
animation-dampening = 15;
animation-clamping = false;

# 窗口动画
animation-for-open-window = "zoom";           # 打开窗口
animation-for-unmap-window = "slide-down";    # 关闭/最小化窗口
animation-for-transient-window = "zoom";      # 弹出窗口

# 工作区切换动画
animation-for-prev-tag = "minimize";
animation-for-next-tag = "slide-in-center";
enable-fading-prev-tag = true;
enable-fading-next-tag = true;

# ============================================================================
# 窗口类型规则
# ============================================================================

wintypes:
{
    tooltip = {
        fade = true;
        shadow = false;
        opacity = 0.95;
        focus = true;
        full-shadow = false;
    };
    
    dock = {
        shadow = false;
        clip-shadow-above = true;
    };
    
    dnd = {
        shadow = false;
    };
    
    popup_menu = {
        opacity = 0.95;
        shadow = true;
        fade = true;
    };
    
    dropdown_menu = {
        opacity = 0.95;
        shadow = true;
        fade = true;
    };
    
    notification = {
        shadow = true;
        fade = true;
    };
};

# ============================================================================
# 虚拟机优化
# ============================================================================

# 在虚拟机中，可以考虑禁用一些高级特性以提高性能
# 如果性能不佳，可以取消注释以下行：

# animations = false;
# blur-method = "none";
# shadow = false;
# fading = false;
